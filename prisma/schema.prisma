// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  CAJERO
  MOZO
}

enum CashMovementType {
  INGRESO
  EGRESO
}

enum TableStatus {
  LIBRE
  OCUPADA
  PIDIENDO_CUENTA
  SUCIA
}

enum OrderStatus {
  PENDIENTE
  PREPARADO
  ENTREGADO
  CANCELADO
}

enum PaymentMethod {
  EFECTIVO
  TARJETA
  YAPE
  PLIN
  TRANSFERENCIA
}

enum ComprobanteType {
  TICKET
  BOLETA
  FACTURA
}

enum SunatStatus {
  PENDIENTE
  ENVIADO
  ACEPTADO
  RECHAZADO
  ANULADO
  NO_APLICA
}

enum CashRegisterStatus {
  ABIERTA
  CERRADA
}

enum PrintStatus {
  PENDING
  PRINTED
  FAILED
  RETRYING
}

model PrintLog {
  id           String      @id @default(uuid())
  orderId      String
  order        Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  floorId      String
  floor        Floor       @relation(fields: [floorId], references: [id])
  status       PrintStatus @default(PENDING)
  attemptCount Int         @default(0)
  lastAttempt  DateTime?
  errorMessage String?
  printerIp    String?
  sentData     Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([orderId])
  @@index([status])
  @@index([floorId])
  @@map("print_logs")
}

model SystemConfig {
  key         String   @id
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

model Floor {
  id          String     @id @default(uuid())
  name        String
  level       Int        @unique
  printerIp   String?
  printerPort Int        @default(9100)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  tables      Table[]
  users       User[]
  categories  Category[]
  printLogs   PrintLog[]

  @@map("floors")
}

model User {
  id        String         @id @default(uuid())
  name      String
  dni       String         @unique
  username  String         @unique
  password  String
  role      UserRole
  isActive  Boolean        @default(true)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  floors    Floor[]
  orders    Order[]
  sales     Sale[]
  sessions  CashRegister[]

  authorizedCancellations OrderCancellation[] @relation("AuthorizedBy")

  @@map("users")
}

model Category {
  id        String     @id @default(uuid())
  name      String
  slug      String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  parentId  String?
  parent    Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children  Category[] @relation("SubCategories")
  products  Product[]
  floors    Floor[]

  @@map("categories")
}

model Product {
  id             String           @id @default(uuid())
  name           String
  description    String?
  price          Decimal          @db.Decimal(10, 2)
  categoryId     String
  category       Category         @relation(fields: [categoryId], references: [id])
  isStockManaged Boolean          @default(true)
  stockDaily     Int              @default(0)
  stockWarehouse Int              @default(0)
  taxType        String           @default("GRAVADO")
  igvRate        Decimal          @default(0.18)
  codigoSunat    String?
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  orderItems     OrderItem[]
  variants       ProductVariant[]

  @@map("products")
}

model ProductVariant {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  name       String
  priceExtra Decimal  @default(0.00) @db.Decimal(10, 2)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("product_variants")
}

model Table {
  id        String      @id @default(uuid())
  number    Int
  name      String
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  floorId   String
  floor     Floor       @relation(fields: [floorId], references: [id])
  status    TableStatus @default(LIBRE)
  posX      Int         @default(0)
  posY      Int         @default(0)
  orders    Order[]

  @@unique([floorId, number])
  @@map("tables")
}

model Order {
  id                String             @id @default(uuid())
  tableId           String
  table             Table              @relation(fields: [tableId], references: [id])
  userId            String
  user              User               @relation(fields: [userId], references: [id])
  status            OrderStatus        @default(PENDIENTE)
  dailyNumber       Int
  orderDate         DateTime           @default(now())
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  items             OrderItem[]
  sale              Sale?
  orderCancellation OrderCancellation?
  printLogs         PrintLog[]

  @@unique([dailyNumber, orderDate, tableId])
  @@index([orderDate, dailyNumber])
  @@map("orders")
}

model OrderCancellation {
  id             String   @id @default(uuid())
  orderId        String   @unique
  order          Order    @relation(fields: [orderId], references: [id])
  reason         String
  authorizedById String?
  authorizedBy   User?    @relation("AuthorizedBy", fields: [authorizedById], references: [id])
  cancelledAt    DateTime @default(now())

  @@map("order_cancellations")
}

model OrderItem {
  id             String   @id @default(uuid())
  orderId        String
  order          Order    @relation(fields: [orderId], references: [id])
  productId      String
  product        Product  @relation(fields: [productId], references: [id])
  quantity       Int
  price          Decimal  @db.Decimal(10, 2)
  notes          String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  variantsDetail Json?
  saleId         String?
  sale           Sale?    @relation(fields: [saleId], references: [id])

  @@map("order_items")
}

model Client {
  id            String   @id @default(uuid())
  docType       String
  docNumber     String   @unique
  name          String
  address       String?
  email         String?
  phone         String?
  loyaltyPoints Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  sales         Sale[]

  @@map("clients")
}

model Sale {
  id                String          @id @default(uuid())
  orderId           String?         @unique
  order             Order?          @relation(fields: [orderId], references: [id])
  userId            String
  user              User            @relation(fields: [userId], references: [id])
  clientId          String?
  client            Client?         @relation(fields: [clientId], references: [id])
  ublVersion        String          @default("2.1")
  type              ComprobanteType
  serie             String
  correlativo       Int
  numeroComprobante String          @unique

  fechaEmision          DateTime      @default(now())
  tipoMoneda            String        @default("PEN")
  montoPagado           Float?
  vuelto                Float?
  metadata              Json?
  empresaRuc            String
  empresaRazonSocial    String
  empresaDireccion      String?
  codigoEstablecimiento String        @default("0000")
  clienteTipoDoc        String
  clienteNumDoc         String
  clienteRazonSocial    String
  clienteDireccion      String?
  montoGravado          Decimal       @default(0.00) @db.Decimal(12, 2)
  montoExonerado        Decimal       @default(0.00) @db.Decimal(12, 2)
  montoInafecto         Decimal       @default(0.00) @db.Decimal(12, 2)
  igv                   Decimal       @default(0.00) @db.Decimal(12, 2)
  icbper                Decimal       @default(0.00) @db.Decimal(12, 2)
  totalImpuestos        Decimal       @default(0.00) @db.Decimal(12, 2)
  valorVenta            Decimal       @default(0.00) @db.Decimal(12, 2)
  precioVentaTotal      Decimal       @default(0.00) @db.Decimal(12, 2)
  montoLetras           String
  itemsSnapshot         Json
  sunatStatus           SunatStatus   @default(PENDIENTE)
  xmlFileName           String?
  xmlPath               String?
  pdfPath               String?
  cdrPath               String?
  cdrCode               String?
  cdrDescription        String?
  cdrNotes              String?
  hash                  String?
  errorCodigo           String?
  errorMensaje          String?
  paymentMethod         PaymentMethod
  formaPago             String        @default("Contado")
  cuotas                Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  orderItems            OrderItem[]

  @@map("sales")
}

model CashRegister {
  id           String             @id @default(uuid())
  userId       String
  user         User               @relation(fields: [userId], references: [id])
  openTime     DateTime           @default(now())
  closeTime    DateTime?
  initialMoney Decimal            @db.Decimal(10, 2)
  finalMoney   Decimal?           @db.Decimal(10, 2)
  systemMoney  Decimal?           @db.Decimal(10, 2)
  difference   Decimal?           @db.Decimal(10, 2)
  status       CashRegisterStatus @default(ABIERTA)
  movements    CashMovement[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@map("cash_registers")
}

model CashMovement {
  id             String           @id @default(uuid())
  cashRegisterId String
  cashRegister   CashRegister     @relation(fields: [cashRegisterId], references: [id])
  amount         Decimal          @db.Decimal(10, 2)
  type           CashMovementType
  description    String
  isAutomatic    Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  metadata       Json?

  @@map("cash_movements")
}

enum AreaOrder {
  COCINA
  BEBIDAS
}

model OrderPrintSequence {
  id         String    @id @default(uuid())
  area       AreaOrder
  date       DateTime
  lastNumber Int       @default(0)

  @@unique([area, date])
}
