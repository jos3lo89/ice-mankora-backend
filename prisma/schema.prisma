// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// ENUMS (Listas estrictas de opciones)
// ==========================================

enum UserRole {
  ADMIN
  CAJERO
  MOZO
}

enum CashMovementType {
  INGRESO
  EGRESO
}

enum TableStatus {
  LIBRE
  OCUPADA
  PIDIENDO_CUENTA // Mesa amarilla
  SUCIA // Requiere limpieza antes de asignar
}

enum OrderStatus {
  PENDIENTE // Enviado a cocina/barra
  PREPARADO // Cocina terminó
  ENTREGADO // En mesa
  CANCELADO // Anulado (Merma)
}

enum PaymentMethod {
  EFECTIVO
  TARJETA
  YAPE
  PLIN
  TRANSFERENCIA
}

enum ComprobanteType {
  TICKET // Nota de venta interna
  BOLETA // SUNAT
  FACTURA // SUNAT
}

enum SunatStatus {
  PENDIENTE // Creado pero no enviado
  ENVIADO // Enviado, esperando respuesta
  ACEPTADO // CDR OK
  RECHAZADO // CDR Error
  ANULADO // Comunicación de baja aceptada
  NO_APLICA // ✅ NUEVO: Para tickets de consumo (no fiscales)
}

enum CashRegisterStatus {
  ABIERTA
  CERRADA
}

// ==========================================
// MÓDULO: GESTIÓN DE IMPRESIONES
// ==========================================

enum PrintStatus {
  PENDING // Esperando impresión
  PRINTED // Impreso exitosamente
  FAILED // Error al imprimir
  RETRYING // Reintentando
}

model PrintLog {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // ✅ CORRECCIÓN: Impresión por PISO, no por área
  floorId String
  floor   Floor  @relation(fields: [floorId], references: [id])

  status PrintStatus @default(PENDING)

  attemptCount Int       @default(0)
  lastAttempt  DateTime?

  errorMessage String?

  // Para auditoría
  printerIp String?
  sentData  Json? // Guarda snapshot de lo enviado

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([status])
  @@index([floorId])
  @@map("print_logs")
}

// ==========================================
// MÓDULO 0: INFRAESTRUCTURA Y SISTEMA
// ==========================================

model SystemConfig {
  key         String   @id
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

// ==========================================
// MÓDULO A: INFRAESTRUCTURA (PISOS Y USUARIOS)
// ==========================================

model Floor {
  id    String @id @default(uuid())
  name  String // Ej: "Piso 1 - Heladería", "Piso 2 - Restaurant"
  level Int    @unique // 1, 2, 3 (Para ordenamiento visual)

  // ✅ NUEVO: Configuración de impresora para este piso
  printerIp   String? // IP de la impresora térmica del piso (ej: "192.168.1.10")
  printerPort Int     @default(9100) // Puerto ESC/POS estándar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  tables     Table[] // Mesas físicas en este piso
  users      User[] // Mozos autorizados para este piso
  categories Category[] // Categorías de productos disponibles aquí
  // ✅ NUEVO: Logs de impresión del piso
  printLogs  PrintLog[]

  @@map("floors")
}

model User {
  id       String   @id @default(uuid())
  name     String // Nombre completo (Para reportes)
  dni      String   @unique // Login y Legal
  username String   @unique // Login rápido (Ej: "JUAN")
  password String // Hash (bcrypt) del PIN o DNI
  role     UserRole

  isActive  Boolean  @default(true) // Soft delete
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relación Muchos a Muchos: Un mozo puede atender varios pisos si falta personal
  floors Floor[]

  // Historial de acciones
  orders   Order[] // Pedidos tomados
  sales    Sale[] // Ventas cobradas
  sessions CashRegister[] // Cajas abiertas

  authorizedCancellations OrderCancellation[] @relation("AuthorizedBy")

  @@map("users")
}

// ==========================================
// MÓDULO B: PRODUCTOS Y ALMACÉN
// ==========================================

model Category {
  id        String   @id @default(uuid())
  name      String // Ej: "Helados", "Parrillas"
  slug      String // URL amigable
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Subcategorías (Recursivo)
  parentId String?
  parent   Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children Category[] @relation("SubCategories")

  products Product[]

  // Disponibilidad por Piso (Vital para tu negocio de 3 niveles)
  floors Floor[]

  @@map("categories")
}

model Product {
  id          String  @id @default(uuid())
  name        String // Ej: "Copa Mankora Especial"
  description String?
  price       Decimal @db.Decimal(10, 2)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  // --- GESTIÓN DE STOCK DUAL ---
  isStockManaged Boolean @default(true) // False para servicios
  stockDaily     Int     @default(0) // "Mise en place" (Ej: 12 hoy)
  stockWarehouse Int     @default(0) // Almacén general (Congeladora)

  // --- DATOS FISCALES BASE ---
  taxType     String  @default("GRAVADO") // 10: Gravado - Operación Onerosa
  igvRate     Decimal @default(0.18) // 18%
  codigoSunat String? // Código de producto SUNAT (opcional pero recomendado)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems OrderItem[]
  variants   ProductVariant[]

  @@map("products")
}

model ProductVariant {
  id         String  @id @default(uuid())
  productId  String
  product    Product @relation(fields: [productId], references: [id])
  name       String // Ej: "Sabor Fresa", "Topping Chocolate"
  priceExtra Decimal @default(0.00) @db.Decimal(10, 2)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_variants")
}

// ==========================================
// MÓDULO C: OPERACIÓN (MESAS Y PEDIDOS)
// ==========================================

model Table {
  id     String @id @default(uuid())
  number Int // Número visual (Mesa 5)
  name   String // "Mesa 5 - Ventana"

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  floorId String
  floor   Floor  @relation(fields: [floorId], references: [id])

  status TableStatus @default(LIBRE)
  posX   Int         @default(0) // Coordenada X en el mapa
  posY   Int         @default(0) // Coordenada Y en el mapa

  orders Order[]

  // Restricción: No puede haber dos "Mesa 5" en el MISMO piso
  @@unique([floorId, number])
  @@map("tables")
}

model Order {
  id String @id @default(uuid())

  tableId String
  table   Table  @relation(fields: [tableId], references: [id])

  userId String // Mozo
  user   User   @relation(fields: [userId], references: [id])

  status OrderStatus @default(PENDIENTE)

  // ✅ NUEVO: Numeración por piso y día
  dailyNumber Int // Número secuencial del día (1, 2, 3...)
  orderDate   DateTime @default(now()) // Fecha de la orden (solo fecha, sin hora)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items             OrderItem[]
  sale              Sale? // Relación 1 a 1 con la Venta (cuando se cobra)
  orderCancellation OrderCancellation?

  // ✅ NUEVO: Relación con impresiones
  printLogs PrintLog[]

  // ✅ NUEVO: Índice compuesto para garantizar unicidad
  @@unique([dailyNumber, orderDate, tableId])
  @@index([orderDate, dailyNumber])
  @@map("orders")
}

model OrderCancellation {
  id String @id @default(uuid())

  orderId String @unique // Relación 1-1 clave
  order   Order  @relation(fields: [orderId], references: [id])

  reason String // "El cliente se fue", "Plato frío"

  authorizedById String? // Quién puso el PIN (Opcional si usas PIN genérico)
  authorizedBy   User?   @relation("AuthorizedBy", fields: [authorizedById], references: [id])

  cancelledAt DateTime @default(now())

  @@map("order_cancellations")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int
  price    Decimal @db.Decimal(10, 2) // Precio congelado al pedir
  notes    String? // "Sin mayonesa"

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Detalles de variantes en texto simple para historial rápido
  variantsDetail Json? // Ej: "Sabor: Lúcuma, Adicional: Chispas"

  saleId String?
  sale   Sale?   @relation(fields: [saleId], references: [id])

  @@map("order_items")
}

// ==========================================
// MÓDULO D: CLIENTES Y FACTURACIÓN (ROBUSTEZ SUNAT)
// ==========================================

model Client {
  id            String   @id @default(uuid())
  docType       String // 1: DNI, 6: RUC
  docNumber     String   @unique
  name          String // Razón Social o Nombre Completo
  address       String?
  email         String?
  phone         String?
  loyaltyPoints Int      @default(0) // Sistema de fidelización
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sales Sale[]

  @@map("clients")
}

model Sale {
  id String @id @default(uuid())

  // --- VINCULACIÓN ---
  orderId  String? @unique
  order    Order?  @relation(fields: [orderId], references: [id])
  userId   String // Cajero
  user     User    @relation(fields: [userId], references: [id])
  clientId String?
  client   Client? @relation(fields: [clientId], references: [id])

  // --- CABECERA DE DOCUMENTO ---
  ublVersion        String          @default("2.1")
  type              ComprobanteType // BOLETA, FACTURA, TICKET
  serie             String // Ej: F001
  correlativo       Int // Ej: 450
  numeroComprobante String          @unique // Ej: "F001-00000450" (Clave única legal)

  fechaEmision DateTime @default(now())
  tipoMoneda   String   @default("PEN")
  montoPagado  Float? // Cuánto pagó el cliente
  vuelto       Float? // Cuánto se le devuelve
  metadata     Json? // { mesa, orden, cajero, mozo }

  // --- SNAPSHOT EMISOR (INMUTABILIDAD) ---
  empresaRuc            String
  empresaRazonSocial    String
  empresaDireccion      String?
  codigoEstablecimiento String  @default("0000") // 0000 Principal

  // --- SNAPSHOT CLIENTE ---
  clienteTipoDoc     String
  clienteNumDoc      String
  clienteRazonSocial String
  clienteDireccion   String?

  // --- TOTALES ---
  montoGravado     Decimal @default(0.00) @db.Decimal(12, 2)
  montoExonerado   Decimal @default(0.00) @db.Decimal(12, 2)
  montoInafecto    Decimal @default(0.00) @db.Decimal(12, 2)
  igv              Decimal @default(0.00) @db.Decimal(12, 2)
  icbper           Decimal @default(0.00) @db.Decimal(12, 2) // Impuesto bolsa
  totalImpuestos   Decimal @default(0.00) @db.Decimal(12, 2)
  valorVenta       Decimal @default(0.00) @db.Decimal(12, 2) // Sin impuestos
  precioVentaTotal Decimal @default(0.00) @db.Decimal(12, 2) // A Pagar

  montoLetras String // Ej: "CIEN SOLES"

  // --- DETALLE ITEMS (JSON) ---
  // Copia exacta de lo enviado a SUNAT (Cantidad, Descripcion, PrecioU, Total)
  itemsSnapshot Json

  // --- ESTADO SUNAT Y ARCHIVOS ---
  sunatStatus SunatStatus @default(PENDIENTE)

  // Rutas en el VPS (No guardar BLOBs)
  xmlFileName String?
  xmlPath     String?
  pdfPath     String?
  cdrPath     String?

  // Respuesta parseada de SUNAT (Para no leer XMLs a cada rato)
  cdrCode        String? // "0" = Éxito
  cdrDescription String?
  cdrNotes       String?
  hash           String? // DigestValue (Firma)

  // Errores de envío
  errorCodigo  String?
  errorMensaje String?

  // --- PAGO ---
  paymentMethod PaymentMethod
  formaPago     String        @default("Contado")
  cuotas        Json? // Array de fechas si es Crédito

  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  orderItems OrderItem[]

  @@map("sales")
}

// ==========================================
// MÓDULO E: CONTROL DE CAJA (ARQUEO Y GASTOS)
// ==========================================

model CashRegister {
  id     String @id @default(uuid())
  userId String // Quién abrió la caja
  user   User   @relation(fields: [userId], references: [id])

  openTime  DateTime  @default(now())
  closeTime DateTime?

  initialMoney Decimal  @db.Decimal(10, 2) // Saldo inicial
  finalMoney   Decimal? @db.Decimal(10, 2) // Saldo declarado al cierre
  systemMoney  Decimal? @db.Decimal(10, 2) // Saldo calculado por el sistema
  difference   Decimal? @db.Decimal(10, 2) // Diferencia (Sobra/Falta)

  status CashRegisterStatus @default(ABIERTA)

  movements CashMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cash_registers")
}

model CashMovement {
  id             String       @id @default(uuid())
  cashRegisterId String
  cashRegister   CashRegister @relation(fields: [cashRegisterId], references: [id])

  amount      Decimal          @db.Decimal(10, 2)
  type        CashMovementType
  description String // Ej: "Compra de leche", "Pago proveedor"
  isAutomatic Boolean          @default(false) // True si viene de una Venta, False si es manual

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cash_movements")
}
